<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Spending Tracker</title>
  <style>
    body { margin: 0; font-family: Arial; background: #f5f5f5; }
    .wrapper { padding: 20px; }
    h2 { margin: 0 0 20px; color: #333; }
    .section { background: white; margin-bottom: 20px; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .section h3 { margin-top: 0; color: #007bff; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
    th { background: #f8f9fa; font-weight: bold; }
    .chart-container { display: flex; gap: 20px; margin-top: 15px; }
    .pie-chart, .bar-chart { flex: 1; background: #f8f9fa; padding: 15px; border-radius: 8px; }
    .category-item {
      margin-bottom: 15px;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px solid #e9ecef;
    }

    .category-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .category-name {
      font-weight: 600;
      color: #495057;
    }

    .category-amount {
      font-weight: 700;
      color: #dc3545;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background-color: #e9ecef;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 5px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #dc3545, #fd7e14);
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    .category-percentage {
      font-size: 12px;
      color: #6c757d;
      text-align: right;
    }

    .no-data {
      text-align: center;
      color: #6c757d;
      font-style: italic;
      padding: 20px;
    }

    .chart-bar-item {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
      padding: 8px;
      background: #f8f9fa;
      border-radius: 6px;
    }

    .bar-label {
      width: 80px;
      font-weight: 600;
      color: #495057;
      font-size: 12px;
    }

    .bar-container {
      flex: 1;
      height: 30px;
      background: #e9ecef;
      border-radius: 4px;
      margin: 0 10px;
      position: relative;
      overflow: hidden;
    }

    .bar-fill {
      background: linear-gradient(45deg, #dc3545, #fd7e14);
      border-radius: 4px;
      transition: height 0.5s ease;
      position: absolute;
      bottom: 0;
      left: 0;
    }

    .bar-value {
      width: 80px;
      text-align: right;
      font-weight: 700;
      color: #dc3545;
      font-size: 12px;
    }

    .pie-chart-container {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .pie-chart-svg {
      flex-shrink: 0;
    }

    .pie-chart-svg svg {
      border-radius: 50%;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .pie-legend {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 6px;
      border-radius: 4px;
      background: #f8f9fa;
    }

    .legend-color {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .legend-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .legend-category {
      font-weight: 600;
      color: #495057;
      font-size: 12px;
    }

    .legend-amount {
      font-size: 11px;
      color: #6c757d;
    }
    .totals { display: flex; gap: 20px; margin-top: 15px; }
    .total-card { flex: 1; background: #e3f2fd; padding: 15px; border-radius: 8px; text-align: center; }
    .total-card h4 { margin: 0 0 10px; color: #1976d2; }
    .total-amount { font-size: 24px; font-weight: bold; color: #1976d2; }
    .comparison { color: #666; font-size: 14px; margin-top: 5px; }
    .loading { text-align: center; padding: 20px; color: #666; }
    .error { color: #d32f2f; background: #ffebee; padding: 10px; border-radius: 4px; margin: 10px 0; }
  </style>
</head>
<body>
  <div class="wrapper">
    <h2>Spending Tracker</h2>
    
    <div class="section">
      <h3>Expense Log</h3>
      <div id="expenseTable">
        <div class="loading">Loading expenses...</div>
      </div>
    </div>

    <div class="section">
      <h3>Category Breakdown</h3>
      <div class="chart-container">
        <div class="pie-chart">
          <h4>Spending by Type</h4>
          <div id="categoryBreakdown">
            <div class="loading">Loading breakdown...</div>
          </div>
        </div>
        <div class="bar-chart">
          <h4>Visual Chart</h4>
          <div id="visualChart">
            <div class="loading">Loading chart...</div>
          </div>
        </div>
      </div>
    </div>

    <div class="section">
      <h3>Monthly/Weekly Totals</h3>
      <div class="totals">
        <div class="total-card">
          <h4>This Month</h4>
          <div class="total-amount" id="thisMonth">₹0</div>
          <div class="comparison" id="monthComparison"></div>
        </div>
        <div class="total-card">
          <h4>This Week</h4>
          <div class="total-amount" id="thisWeek">₹0</div>
          <div class="comparison" id="weekComparison"></div>
        </div>
        <div class="total-card">
          <h4>Today</h4>
          <div class="total-amount" id="today">₹0</div>
        </div>
      </div>
    </div>
  </div>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
  
  const supabaseUrl = 'https://xqzdvxyefnhekxaujivq.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhxemR2eHllZm5oZWt4YXVqaXZxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyMTc1MjksImV4cCI6MjA3Mzc5MzUyOX0.RR4VMAQ6CikKyELyY_tSAlfspX5i65fpAEaEbBqF9co';
  const supabase = createClient(supabaseUrl, supabaseKey);

  let currentUser = null;
  let expenses = [];

  async function loadUser() {
    const email = localStorage.getItem('currentUserEmail');
    if (!email) {
      document.body.innerHTML = '<div class="error">Please login first</div>';
      return;
    }

    const { data: users, error } = await supabase
      .from('users')
      .select('*')
      .eq('gmail', email);

    if (error || !users || users.length === 0) {
      document.body.innerHTML = '<div class="error">User not found</div>';
      return;
    }

    currentUser = users[0];
    loadExpenses();
  }

  async function loadExpenses() {
    try {
      // First, let's fetch all transactions to see what we have
      const { data: allTransactions, error: allError } = await supabase
        .from('transactions')
        .select('*')
        .eq('user_name', currentUser.name)
        .order('date', { ascending: false });

      if (allError) throw allError;

      console.log('All transactions:', allTransactions);

      // Filter for income category only from transactions table
      expenses = allTransactions.filter(transaction => {
        // Show only transactions where category is 'income'
        if (transaction.category === 'income') return true;
        
        return false;
      });

      console.log('Total transactions fetched:', allTransactions.length);
      console.log('Spending transactions filtered:', expenses.length);
      console.log('Filtered expenses:', expenses);

      displayExpenses();
      displayCategoryBreakdown();
      displayVisualChart();
      displayTotals();
    } catch (error) {
      document.getElementById('expenseTable').innerHTML = `<div class="error">Error loading expenses: ${error.message}</div>`;
    }
  }

  function displayExpenses() {
    const tableHtml = `
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Type</th>
            <th>Category</th>
            <th>Description</th>
            <th>Amount</th>
            <th>Notes</th>
          </tr>
        </thead>
        <tbody>
          ${expenses.map(expense => `
            <tr>
              <td>${new Date(expense.date).toLocaleDateString()}</td>
              <td>${expense.type}</td>
              <td>${expense.category || '-'}</td>
              <td>${expense.description || '-'}</td>
              <td>₹${Math.abs(expense.amount)}</td>
              <td>${expense.notes || '-'}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;
    document.getElementById('expenseTable').innerHTML = tableHtml;
  }

  function displayCategoryBreakdown() {
    const categoryTotals = {};
    expenses.forEach(expense => {
      const type = expense.type || 'Other';
      categoryTotals[type] = (categoryTotals[type] || 0) + Math.abs(expense.amount);
    });

    const total = Object.values(categoryTotals).reduce((sum, amount) => sum + amount, 0);
    
    if (total === 0) {
      document.getElementById('categoryBreakdown').innerHTML = '<div class="no-data">No expense data available</div>';
      return;
    }

    const breakdownHtml = Object.entries(categoryTotals)
      .sort((a, b) => b[1] - a[1])
      .map(([category, amount]) => {
        const percentage = ((amount / total) * 100).toFixed(1);
        return `
          <div class="category-item">
            <div class="category-header">
              <span class="category-name">${category}</span>
              <span class="category-amount">₹${amount.toLocaleString()}</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${percentage}%"></div>
            </div>
            <div class="category-percentage">${percentage}%</div>
          </div>
        `;
      }).join('');

    document.getElementById('categoryBreakdown').innerHTML = breakdownHtml;
  }

  function displayVisualChart() {
    const categoryTotals = {};
    expenses.forEach(expense => {
      const type = expense.type || 'Other';
      categoryTotals[type] = (categoryTotals[type] || 0) + Math.abs(expense.amount);
    });

    const total = Object.values(categoryTotals).reduce((sum, amount) => sum + amount, 0);
    
    if (total === 0) {
      document.getElementById('visualChart').innerHTML = '<div class="no-data">No expense data available</div>';
      return;
    }

    // Create a pie chart visualization
    const colors = ['#dc3545', '#fd7e14', '#ffc107', '#28a745', '#17a2b8', '#6f42c1', '#e83e8c', '#6c757d'];
    let cumulativePercentage = 0;
    
    const chartHtml = `
      <div class="pie-chart-container">
        <div class="pie-chart-svg">
          <svg width="200" height="200" viewBox="0 0 200 200">
            ${Object.entries(categoryTotals)
              .sort((a, b) => b[1] - a[1])
              .map(([category, amount], index) => {
                const percentage = (amount / total) * 100;
                const startAngle = (cumulativePercentage / 100) * 360;
                const endAngle = ((cumulativePercentage + percentage) / 100) * 360;
                cumulativePercentage += percentage;
                
                const startAngleRad = (startAngle - 90) * (Math.PI / 180);
                const endAngleRad = (endAngle - 90) * (Math.PI / 180);
                
                const x1 = 100 + 80 * Math.cos(startAngleRad);
                const y1 = 100 + 80 * Math.sin(startAngleRad);
                const x2 = 100 + 80 * Math.cos(endAngleRad);
                const y2 = 100 + 80 * Math.sin(endAngleRad);
                
                const largeArcFlag = percentage > 50 ? 1 : 0;
                
                const pathData = [
                  `M 100 100`,
                  `L ${x1} ${y1}`,
                  `A 80 80 0 ${largeArcFlag} 1 ${x2} ${y2}`,
                  `Z`
                ].join(' ');
                
                return `<path d="${pathData}" fill="${colors[index % colors.length]}" stroke="#fff" stroke-width="2"/>`;
              }).join('')}
          </svg>
        </div>
        <div class="pie-legend">
          ${Object.entries(categoryTotals)
            .sort((a, b) => b[1] - a[1])
            .map(([category, amount], index) => {
              const percentage = ((amount / total) * 100).toFixed(1);
              return `
                <div class="legend-item">
                  <div class="legend-color" style="background-color: ${colors[index % colors.length]}"></div>
                  <div class="legend-text">
                    <span class="legend-category">${category}</span>
                    <span class="legend-amount">₹${amount.toLocaleString()} (${percentage}%)</span>
                  </div>
                </div>
              `;
            }).join('')}
        </div>
      </div>
    `;

    document.getElementById('visualChart').innerHTML = chartHtml;
  }

  function displayTotals() {
    const now = new Date();
    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
    const startOfWeek = new Date(now.setDate(now.getDate() - now.getDay()));
    const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate());

    const thisMonth = expenses
      .filter(e => new Date(e.date) >= startOfMonth)
      .reduce((sum, e) => sum + Math.abs(e.amount), 0);

    const thisWeek = expenses
      .filter(e => new Date(e.date) >= startOfWeek)
      .reduce((sum, e) => sum + Math.abs(e.amount), 0);

    const today = expenses
      .filter(e => new Date(e.date) >= startOfDay)
      .reduce((sum, e) => sum + Math.abs(e.amount), 0);

    document.getElementById('thisMonth').textContent = `₹${thisMonth.toLocaleString()}`;
    document.getElementById('thisWeek').textContent = `₹${thisWeek.toLocaleString()}`;
    document.getElementById('today').textContent = `₹${today.toLocaleString()}`;

    // Add comparison logic here if needed
    document.getElementById('monthComparison').textContent = 'vs last month';
    document.getElementById('weekComparison').textContent = 'vs last week';
  }

  loadUser();
</script>
</body>
</html>
