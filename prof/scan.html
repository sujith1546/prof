<div id="page-content">
  <div class="page-title">
    <h2>Scan</h2>
    <p>Upload CSV/Text files to import transaction data</p>
  </div>

  <div class="scan-container">
    <div class="scan-section">
      <h3>üìÑ File Upload</h3>
      <div class="scanner-area">
        <div class="scanner-placeholder">
          <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
            <polyline points="14,2 14,8 20,8"/>
            <line x1="16" y1="13" x2="8" y2="13"/>
            <line x1="16" y1="17" x2="8" y2="17"/>
            <polyline points="10,9 9,9 8,9"/>
          </svg>
          <p>Upload CSV or Text file with transaction data</p>
          <p class="file-format">Expected format: Date, Category, Description, Amount, Notes</p>
          <input type="file" id="fileInput" accept=".csv,.txt" style="display: none;">
          <button class="scan-btn" onclick="document.getElementById('fileInput').click()">
            Choose File
          </button>
        </div>
      </div>
    </div>

    <div class="scan-section" id="previewSection" style="display: none;">
      <h3>üìã Data Preview</h3>
      <div class="preview-container">
        <div class="preview-header">
          <span>Review the parsed data before saving</span>
          <div class="category-selection">
            <label for="categorySelect">Select Category:</label>
            <select id="categorySelect" required>
              <option value="">Choose category</option>
              <option value="income">Income</option>
              <option value="spending">Spending</option>
            </select>
            <button class="save-btn" id="saveBtn" onclick="saveTransactions()">
              üíæ Save to Database
            </button>
          </div>
        </div>
        <div class="table-container">
          <table id="previewTable">
            <thead>
              <tr>
                <th>Date</th>
                <th>Category</th>
                <th>Description</th>
                <th>Amount</th>
                <th>Notes</th>
              </tr>
            </thead>
            <tbody id="previewTableBody">
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="scan-section">
      <h3>‚ÑπÔ∏è File Format Instructions</h3>
      <div class="instructions">
        <p><strong>Supported formats:</strong> CSV (.csv) or Text (.txt)</p>
        <p><strong>Required columns:</strong> Date, Category, Description, Amount, Notes</p>
        
        <div class="type-requirements">
          <h4>üìã Type Requirements (Mandatory)</h4>
          <div class="requirement-section">
            <div class="requirement-category">
              <h5>üí∞ For Income Category:</h5>
              <div class="type-tags">
                <span class="type-tag income">Salary</span>
                <span class="type-tag income">Freelance</span>
                <span class="type-tag income">Passive</span>
                <span class="type-tag income">Other</span>
              </div>
            </div>
            
            <div class="requirement-category">
              <h5>üí∏ For Spending Category:</h5>
              <div class="type-tags">
                <span class="type-tag spending">Housing</span>
                <span class="type-tag spending">Utilities</span>
                <span class="type-tag spending">Food</span>
                <span class="type-tag spending">Transport</span>
                <span class="type-tag spending">Health</span>
                <span class="type-tag spending">Entertainment</span>
                <span class="type-tag spending">Education</span>
                <span class="type-tag spending">Insurance / EMIs / Subscriptions</span>
                <span class="type-tag spending">Miscellaneous (Misc.)</span>
              </div>
            </div>
          </div>
        </div>
        
        <p><strong>Example format:</strong></p>
        <div class="example">
          <code>
            Date,Category,Description,Amount,Notes<br>
            2024-01-15,Food,Grocery shopping,150.00,Weekly groceries<br>
            2024-01-16,Transport,Gas station,45.50,Fuel for car<br>
            2024-01-17,Entertainment,Movie ticket,12.00,Weekend movie
          </code>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .scan-container {
    display: flex;
    flex-direction: column;
    gap: 30px;
  }

  .scan-section {
    background: #fff;
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }

  .scan-section h3 {
    margin: 0 0 20px 0;
    color: #333;
    font-size: 18px;
    font-weight: 600;
  }

  .scanner-area {
    border: 2px dashed #ddd;
    border-radius: 8px;
    padding: 40px;
    text-align: center;
    background: #fafafa;
    transition: all 0.3s ease;
  }

  .scanner-area:hover {
    border-color: #007bff;
    background: #f0f8ff;
  }

  .scanner-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 16px;
  }

  .scanner-placeholder svg {
    color: #666;
  }

  .scanner-placeholder p {
    margin: 0;
    color: #666;
    font-size: 16px;
  }

  .file-format {
    font-size: 14px;
    color: #888;
    margin-top: 8px;
  }

  .scan-btn {
    background: #007bff;
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.3s ease;
  }

  .scan-btn:hover {
    background: #0056b3;
  }

  .recent-scans {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .scan-item {
    display: flex;
    align-items: center;
    padding: 16px;
    background: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #e9ecef;
  }

  .scan-icon {
    font-size: 24px;
    margin-right: 16px;
  }

  .scan-details {
    flex: 1;
  }

  .scan-name {
    font-weight: 600;
    color: #333;
    margin-bottom: 4px;
  }

  .scan-date {
    font-size: 14px;
    color: #666;
  }

  .scan-actions {
    display: flex;
    gap: 8px;
  }

  .action-btn {
    background: #6c757d;
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 4px;
    font-size: 12px;
    cursor: pointer;
    transition: background 0.3s ease;
  }

  .action-btn:hover {
    background: #545b62;
  }

  .action-btn:first-child {
    background: #28a745;
  }

  .action-btn:first-child:hover {
    background: #1e7e34;
  }

  .preview-container {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 20px;
  }

  .preview-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid #dee2e6;
  }

  .category-selection {
    display: flex;
    align-items: center;
    gap: 15px;
  }

  .category-selection label {
    font-weight: 600;
    color: #495057;
    margin: 0;
  }

  .category-selection select {
    padding: 8px 12px;
    border: 2px solid #dee2e6;
    border-radius: 6px;
    background: white;
    font-size: 14px;
    min-width: 120px;
  }

  .category-selection select:focus {
    outline: none;
    border-color: #007bff;
  }


  .save-btn {
    background: #28a745;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.3s ease;
  }

  .save-btn:hover {
    background: #1e7e34;
  }

  .table-container {
    max-height: 400px;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 6px;
  }

  #previewTable {
    width: 100%;
    border-collapse: collapse;
    background: white;
  }

  #previewTable th {
    background: #f8f9fa;
    padding: 12px;
    text-align: left;
    font-weight: 600;
    color: #495057;
    border-bottom: 2px solid #dee2e6;
    position: sticky;
    top: 0;
  }

  #previewTable td {
    padding: 10px 12px;
    border-bottom: 1px solid #dee2e6;
    color: #495057;
  }

  #previewTable tr:hover {
    background: #f8f9fa;
  }

  .instructions {
    background: #e3f2fd;
    padding: 20px;
    border-radius: 8px;
    border-left: 4px solid #2196f3;
  }

  .instructions p {
    margin: 8px 0;
    color: #333;
  }

  .example {
    background: #f5f5f5;
    padding: 15px;
    border-radius: 4px;
    margin-top: 10px;
    font-family: 'Courier New', monospace;
    font-size: 12px;
    overflow-x: auto;
  }

  .example code {
    color: #333;
    line-height: 1.4;
  }

  .type-requirements {
    margin: 20px 0;
    padding: 20px;
    background: #fff3cd;
    border: 2px solid #ffc107;
    border-radius: 8px;
  }

  .type-requirements h4 {
    margin: 0 0 15px 0;
    color: #856404;
    font-size: 16px;
  }

  .requirement-section {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  .requirement-category h5 {
    margin: 0 0 10px 0;
    color: #495057;
    font-size: 14px;
  }

  .type-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .type-tag {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    border: 2px solid;
  }

  .type-tag.income {
    background: #d4edda;
    color: #155724;
    border-color: #28a745;
  }

  .type-tag.spending {
    background: #f8d7da;
    color: #721c24;
    border-color: #dc3545;
  }
</style>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
  
  const supabaseUrl = 'https://xqzdvxyefnhekxaujivq.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhxemR2eHllZm5oZWt4YXVqaXZxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyMTc1MjksImV4cCI6MjA3Mzc5MzUyOX0.RR4VMAQ6CikKyELyY_tSAlfspX5i65fpAEaEbBqF9co';
  const supabase = createClient(supabaseUrl, supabaseKey);

  let parsedData = [];
  let currentUser = null;

  // Load current user
  async function loadUser() {
    const email = localStorage.getItem('currentUserEmail');
    if (!email) {
      alert('Please login first');
      return;
    }

    const { data: users, error } = await supabase
      .from('users')
      .select('*')
      .eq('gmail', email);

    if (error || !users || users.length === 0) {
      alert('User not found');
      return;
    }

    currentUser = users[0];
  }

  // Handle file upload
  document.getElementById('fileInput').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
      parseFile(file);
    }
  });

  // Parse CSV/Text file
  function parseFile(file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      const content = e.target.result;
      parseCSV(content);
    };
    reader.readAsText(file);
  }

  // Parse CSV content
  function parseCSV(content) {
    const lines = content.split('\n').filter(line => line.trim());
    if (lines.length < 2) {
      alert('File must contain at least a header row and one data row');
      return;
    }

    // Parse header
    const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
    const expectedHeaders = ['date', 'category', 'description', 'amount', 'notes'];
    
    // Check if headers match expected format
    const hasAllHeaders = expectedHeaders.every(header => 
      headers.some(h => h.includes(header))
    );

    if (!hasAllHeaders) {
      alert('File must contain columns: Date, Category, Description, Amount, Notes');
      return;
    }

    // Parse data rows
    parsedData = [];
    for (let i = 1; i < lines.length; i++) {
      const values = lines[i].split(',').map(v => v.trim());
      if (values.length >= 4) {
        parsedData.push({
          date: values[0] || '',
          type: values[1] || '',
          description: values[2] || '',
          amount: parseFloat(values[3]) || 0,
          notes: values[4] || ''
        });
      }
    }

    if (parsedData.length === 0) {
      alert('No valid data found in file');
      return;
    }

    displayPreview();
  }

  // Display preview table
  function displayPreview() {
    const previewSection = document.getElementById('previewSection');
    const tableBody = document.getElementById('previewTableBody');
    
    previewSection.style.display = 'block';
    
    tableBody.innerHTML = parsedData.map(row => `
      <tr>
        <td>${row.date}</td>
        <td>${row.type}</td>
        <td>${row.description}</td>
        <td>‚Çπ${row.amount.toFixed(2)}</td>
        <td>${row.notes}</td>
      </tr>
    `).join('');

    // Scroll to preview section
    previewSection.scrollIntoView({ behavior: 'smooth' });
  }

  // Save transactions to database
  async function saveTransactions() {
    if (!currentUser) {
      await loadUser();
    }

    if (!currentUser) {
      alert('User not found. Please login again.');
      return;
    }

    if (parsedData.length === 0) {
      alert('No data to save');
      return;
    }

    // Get selected category
    const selectedCategory = document.getElementById('categorySelect').value;
    if (!selectedCategory) {
      alert('Please select a category (Income or Spending)');
      return;
    }

    try {
      // Prepare data for insertion
      const transactionsToInsert = parsedData.map(row => ({
        user_name: currentUser.name,
        type: row.type,
        description: row.description,
        amount: row.amount,
        date: row.date,
        notes: row.notes,
        category: selectedCategory
      }));

      // Insert into database
      const { data, error } = await supabase
        .from('transactions')
        .insert(transactionsToInsert);

      if (error) throw error;

      alert(`Successfully saved ${parsedData.length} transactions as ${selectedCategory}!`);
      
      // Reset form
      document.getElementById('fileInput').value = '';
      document.getElementById('previewSection').style.display = 'none';
      document.getElementById('categorySelect').value = '';
      parsedData = [];

    } catch (error) {
      alert('Error saving transactions: ' + error.message);
    }
  }

  // Make functions globally available
  window.saveTransactions = saveTransactions;

  // Load user on page load
  loadUser();
</script>
